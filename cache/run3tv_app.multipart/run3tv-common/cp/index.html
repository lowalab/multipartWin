<!doctype html>
<html>
<head>
<title>Control Panel</title>
<meta charset="UTF-8">
<style>
legend {
    margin: 6px;
    padding: 6px;
    border: 1px solid black;
}
form {
    display: inline-block;
    padding: 10px;
}
</style>
</head>
<body>
<h2>Receiver Emulator - Control Panel</h2>
<div id="cp"></div>
<script>
var uri = window.location.origin + "/cmd-admin", pin = prompt("Enter PIN:");
if (pin !== null) {
    pin |= 0; // cache
    fetch(uri, {method: "POST", body: JSON.stringify({verify: pin})})
    .then(function (res) { return res.json(); })
    .then(function (res) {
        if ('verify' in res) {
            if (res.verify) {
                start();
            } else {
                alert("Invalid PIN number.");
                document.getElementById("cp").innerHTML = info();
            }
        } else if ('error' in res) {
            alert("Error: " + res.error);
            window.location.reload();
        } else {
            console.error("Invalid response:", res);
            alert("Internal error.");
            window.location.reload();
        }
    })
    .catch(function (err) {
        alert("Fetch error: " + err.message);
    });
} else {
    document.getElementById("cp").innerHTML = info();
}

function exit(v) {
    return Promise.reject(new Error(v));
}
function info() {
    return '\
<form onsubmit="window.location.reload();return false;" action="javascript: void(0)">\
<fieldset style="background-color: #feffe5"><legend style="background-color: #e5eef7">PIN Reset</legend>\
Reload this page in order to enter/reset the PIN number.<br><br>\
<input type="submit" value="Page Reload">\
</fieldset></form>';
}

function start() {
    document.getElementById("cp").innerHTML = '\
<form onsubmit="return cmd(this)" action="javascript: void(0)">\
<fieldset name="frm" style="background-color: #e5eef7"><legend style="background-color: #feffe5">Send Notify</legend>\
<input type="hidden" name="fc" value="atscCmd.notify">\
Notify list URL: <input name="url" type="text" maxlength="200" style="width: 640px" value="notifyList.json"> <button onclick="return loadList(this.form)">Load</button><br><br>\
Select data notify: <select name="opt" onchange="select(this)"><option disabled>Load notify list first</option></select><br><br>\
Notify params object:<br><textarea name="data" rows="20" cols="120"></textarea><br><br>\
Client cid number: <input name="cid" type="number" maxlength="10" min="0" step="1" value="0" style="width: 100px"> <input type="submit" value="Send Notify">\
</fieldset></form>\
\
<form onsubmit="return cmd(this)" action="javascript: void(0)">\
<fieldset name="frm" style="background-color: #f7e5e5"><legend style="background-color: #e5ffea">Stream Event</legend>\
<input type="hidden" name="fc" value="atscCmd.streamEvent">\
Stream events URL: <input name="url" type="text" maxlength="200" style="width: 640px" value="streamEvents.json"> <button onclick="return loadList(this.form)">Load</button><br><br>\
Select event stream: <select name="opt" onchange="select(this)"><option disabled>Load stream events first</option></select><br><br>\
Event params object:<br><textarea name="data" rows="20" cols="120"></textarea><br><br>\
Client cid number: <input name="cid" type="number" maxlength="10" min="0" step="1" value="0" style="width: 100px"> <input type="submit" value="Send Event">\
</fieldset></form>\
\
<form onsubmit="return cmd(this)" action="javascript: void(0)">\
<fieldset name="frm" style="background-color: #feffe5"><legend style="background-color: #e5eef7">Set Response</legend>\
<input type="hidden" name="fc" value="atscCmd.setClientResponse">\
Response list URL: <input name="url" type="text" maxlength="200" style="width: 640px" value="A344_2019.json"> <button onclick="return loadList(this.form)">Load</button><br><br>\
Select data response: <select name="opt" onchange="select(this)"><option disabled>Load response list first</option></select><br><br>\
Method response object:<br><textarea name="data" rows="20" cols="120"></textarea><br><br>\
Client cid number: <input name="cid" type="number" maxlength="10" min="0" step="1" value="0" style="width: 100px"> <input type="submit" value="Set Response">\
<button style="float: right" onclick="return setClientToDefault(this.form.cid.value)">Reset to Default</button>\
</fieldset></form>\
\
<form onsubmit="return cmd(this)" action="javascript: void(0)">\
<fieldset name="frm" style="background-color: #e5ffea"><legend style="background-color: #f7e5e5">Default Response</legend>\
<input type="hidden" name="fc" value="atscCmd.setDefaultResponseList">\
Response list URL: <input name="res" type="text" maxlength="200" style="width: 640px" value="A344_2019.json"> <button onclick="return preview(this.form.res.value, this.form.data)">Preview</button><br><br>\
Default list URL: <input name="def" type="text" maxlength="200" style="width: 640px" value="default_1.json"> <button onclick="return preview(this.form.def.value, this.form.data)">Preview</button><br><br>\
Preview:<br><textarea name="data" rows="20" cols="120"></textarea><br><br>\
<button onclick="return prevDefault(this.form)">Select</button> <input type="submit" value="Set Default Response List">\
<button style="float: right" onclick="return getDefaultResponseList(this.form)">Get Default Response List</button>\
</fieldset></form>\
\
<form onsubmit="return cmd(this)" action="javascript: void(0)">\
<fieldset name="frm" style="background-color: #e5eef7"><legend style="background-color: #feffe5">Proxy List</legend>\
<input type="hidden" name="fc" value="proxy">\
Proxy list URL: <input name="res" type="text" maxlength="200" style="width: 640px" value="proxy.json"> <button onclick="return preview(this.form.res.value, this.form.data)">Preview</button><br><br>\
Preview:<br><textarea name="data" rows="20" cols="120"></textarea><br><br>\
<input type="submit" value="Set & Get Proxy URLs">\
</fieldset></form>' + info();
}

function cmd(frm) {
    try {
        var data = JSON.parse(frm.data.value);
        frm.frm.disabled = true;
        var obj = {fc: frm.fc.value, list: data, pin: pin};
        if ('cid' in frm) { obj.cid = frm.cid.value | 0; }
        fetch(uri, {method: "POST", body: JSON.stringify(obj)})
        .then(function (res) { return res.status === 200 ? res.json() : res.text().then(exit); })
        .then(function (res) {
            console.log(res);
            if ('result' in res) {
                alert("Submit success.");
                if (frm.fc.value === "proxy") { frm.data.value = JSON.stringify(res.result, null, 2); }
            } else if ('error' in res) {
                alert("Error: " + res.error);
            } else {
                alert("Internal error.");
            }
            frm.frm.disabled = false;
        })
        .catch(function (err) {
            alert("Fetch error: " + err.message);
            frm.frm.disabled = false;
        });
    } catch (err) {
        alert("Invalid data object: " + err.message);
    }
    return false;
}

function select(opt) {
    opt.form.data.value = JSON.stringify(obj[opt.form.fc.value][opt.value], null, 2); // 2 - tab: two white spaces
}

var obj = {};
function loadList(frm) {
    fetch(frm.url.value)
    .then(function (res) { return res.status === 200 ? res.json() : res.text().then(exit); })
    .then(function (res) {
        obj[frm.fc.value] = res;
        frm.opt.innerHTML = '<option disabled>Select</option><option disabled>-------</option>';
        var opt;
        for (var value of Object.keys(res)) {
            opt = document.createElement("option");
            opt.value = opt.text = value;
            frm.opt.add(opt);
        }
        frm.opt.selectedIndex = 0;
    })
    .catch(function (err) {
        alert("Fetch error: " + err.message);
    });
    return false;
}

function preview(url, txt) {
    fetch(url)
    .then(function (res) { return res.status === 200 ? res.json() : res.text().then(exit); })
    .then(function (res) {
        txt.value = JSON.stringify(res, null, 2);
    })
    .catch(function (err) {
        alert("Fetch error: " + err.message);
    });
    return false;
}

function prevDefault(frm) {
    frm.frm.disabled = true;
    var v;
    fetch(frm.res.value)
    .then(function (r) { return r.status === 200 ? r.json() : r.text().then(exit); })
    .then(function (r) {
        v = r;
        return fetch(frm.def.value);
    })
    .then(function (r) { return r.status === 200 ? r.json() : r.text().then(exit); })
    .then(function (r) {
        var o = {};
        for (var k in r) { // k - method, r[k] - custom key name (index)
            if (r[k] in v && k in v[r[k]]) { o[k] = v[r[k]][k]; }
        }
        frm.data.value = JSON.stringify(o, null, 2);
        frm.frm.disabled = false;
    })
    .catch(function (err) {
        alert("Fetch error: " + err.message);
        frm.frm.disabled = false;
    });
    return false;
}

function getDefaultResponseList(frm) {
    frm.frm.disabled = true;
    fetch(uri, {method: "POST", body: JSON.stringify({fc: "atscCmd.getDefaultResponseList", pin: pin})})
    .then(function (res) { return res.status === 200 ? res.json() : res.text().then(exit); })
    .then(function (res) {
        console.log(res);
        if ('result' in res) {
            if (res.result) {
                frm.data.value = JSON.stringify(res.result, null, 2);
            } else {
                alert("Error: default atscCmd interface not found.");
            }
        } else if ('error' in res) {
            alert("Error: " + res.error);
        } else {
            alert("Internal error.");
        }
        frm.frm.disabled = false;
    })
    .catch(function (err) {
        alert("Fetch error: " + err.message);
        frm.frm.disabled = false;
    });
    return false;
}

function setClientToDefault(cid) {
    fetch(uri, {method: "POST", body: JSON.stringify({fc: "atscCmd.setClientToDefault", cid: cid | 0, pin: pin})})
    .then(function (res) { return res.status === 200 ? res.json() : res.text().then(exit); })
    .then(function (res) {
        console.log(res);
        if ('result' in res) {
            alert("Submit success.");
        } else if ('error' in res) {
            alert("Error: " + res.error);
        } else {
            alert("Internal error.");
        }
    })
    .catch(function (err) {
        alert("Fetch error: " + err.message);
    });
    return false;
}
</script>
</body>
</html>
